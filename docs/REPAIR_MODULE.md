# 数据库修复功能说明

## 功能简介

数据库修复模块用于自动检测和修复Bilibili评论数据中的常见数据完整性问题，保障数据健康，提升系统可用性。适用于数据异常、导入错误、日常维护等场景。

## 支持修复的问题类型

- **空视频标题**：自动设为"未知标题"
- **重复BV号**：保留第一条，删除重复项
- **孤立评论**：删除无对应视频的评论
- **重复评论**：保留第一条，删除重复项
- **空评论内容**：设为"[内容已删除]"
- **异常时间戳**：修正为当前时间
- **无效父/子评论引用**：删除无效关系
- **自引用关系**：删除自引用
- **统计不一致/缺失**：重新计算或补全统计信息

## 问题类型说明

| 问题类型                | 说明                         |
|-------------------------|------------------------------|
| empty_video_title       | 视频标题为空                 |
| duplicate_bvid          | 存在重复的BV号               |
| orphan_comments         | 评论无对应视频（孤立评论）   |
| duplicate_comments      | 存在重复的评论               |
| empty_comment_content   | 评论内容为空                 |
| invalid_timestamp       | 评论时间戳异常               |
| invalid_parent_reference| 父评论引用无效               |
| invalid_child_reference | 子评论引用无效               |
| self_reference          | 评论自引用                   |
| inconsistent_stats      | 统计信息与实际不符           |
| missing_stats           | 缺失统计信息                 |
| video_not_found         | 视频不存在                   |

## 使用方式

### 1. Web界面

1. 启动程序：`./bilibili-comments-viewer-go.exe`
2. 浏览器访问：`http://localhost:8080/repair`
3. 可选择：
   - 校验/修复整个数据库
   - 校验/修复指定BV号视频
   - 查看修复详情与日志

### 2. API接口

- 校验数据库：`GET /api/repair/validate`
- 校验指定视频：`GET /api/repair/validate/{bvid}`
- 修复数据库：`POST /api/repair/fix`
- 修复指定视频：`POST /api/repair/fix/{bvid}`

返回JSON结果，包含问题类型、数量、修复状态等。

## 修复策略简述

针对每类常见问题，修复策略如下：

| 问题类型                | 修复策略说明                                                   |
|-------------------------|----------------------------------------------------------------|
| empty_video_title       | 将空或缺失的视频标题设为"未知标题"                             |
| duplicate_bvid          | 保留首条记录，删除后续重复的BV号视频记录                       |
| orphan_comments         | 删除无对应视频的评论                                           |
| duplicate_comments      | 保留首条评论，删除重复评论                                     |
| empty_comment_content   | 将空内容评论设为"[内容已删除]"                                 |
| invalid_timestamp       | 将异常时间戳修正为当前时间                                     |
| invalid_parent_reference| 删除无效的父评论引用关系                                       |
| invalid_child_reference | 删除无效的子评论引用关系                                       |
| self_reference          | 删除评论的自引用关系                                           |
| inconsistent_stats      | 重新统计并更新评论数等统计信息                                 |
| missing_stats           | 为缺失的统计信息自动补全                                       |
| video_not_found         | 跳过或提示该视频不存在，相关评论可视情况处理                   |

- 所有修复操作均会记录详细日志，便于追溯和排查。
- 修复过程中如遇无法自动修复的问题，将在结果中提示需人工处理。

## 安全与注意事项

- 建议修复前备份数据库文件（如 `database.db`）
- 修复操作涉及数据变更，务必确认无其他程序占用数据库
- 大型数据库修复可能耗时较长，建议在系统空闲时进行
- 所有修复和校验操作均有详细日志记录（见 `logs/app.log`）

## 常见问题与排查

- **修复失败**：检查数据库文件权限、日志获取详细错误
- **部分问题无法自动修复**：需手动处理或反馈开发者
- **性能问题**：建议分批修复或仅修复指定视频

## 后续计划/扩展

- 支持批量修复、修复历史记录、导出校验报告
- 增加自定义修复策略与定时自动校验
- 丰富前端修复预览与对比功能

---

如遇疑难问题，请先查阅日志文件，或在社区/项目主页反馈。 